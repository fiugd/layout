<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Layout Test</title>
		<meta charset="utf-8" />
		<meta name="description" content="" />
		<meta name="author" content="" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="mobile-web-app-capable" content="yes" />
		<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon" />
		<link rel="stylesheet" href="index.css" />
	</head>

	<style>
		@media (prefers-color-scheme: dark) {
			html {
				background: #2a2a2a;
				color: white;
			}
		}
		html,
		body {
			overscroll-behavior-x: none;
		}
	</style>

	<body></body>

	<script type="module">
		import YAML from "https://cdn.skypack.dev/yaml";

		//import Layout from "https://unpkg.com/@fiug/layout@0.0.0-6";
		import Layout from "../src/index.js";

		function debounce(func, timeout = 500) {
			let timer;
			return (...args) => {
				clearTimeout(timer);
				timer = setTimeout(() => {
					func.apply(this, args);
				}, timeout);
			};
		}

		const storedLayout = (() => {
			try {
				const s = sessionStorage.getItem("test-layout-example");
				if (!s) return;
				return JSON.parse(s);
			} catch (e) {
				console.log(e);
			}
		})();

		let layoutConfig = storedLayout || "layout.fiug.yaml";
		//layoutConfig = 'layout.fiug.yaml';

		if (typeof layoutConfig !== "object") {
			const url = layoutConfig;
			const source = await fetch(layoutConfig).then((r) => r.text());
			if (url.includes(".json")) {
				layoutConfig = JSON.parse(source);
			}
			if (url.includes(".yml") || url.includes(".yaml")) {
				layoutConfig = YAML.parse(source);
			}
		}

		const layout = new Layout({
			...layoutConfig,
			parent: document.body
		});

		let activeEditor = document.querySelector('.pane.active')?.id;

		layout.on('change', debounce((config) => {
			const configString = JSON.stringify(config, null, 2);
			//console.log(configString);
			sessionStorage.setItem("test-layout-example", configString);
		}));
		layout.on('open', ({ file, pane }) => {
			// - a file has been dropped onto a pane
			// - a new tab is opened in a pane
			console.log(`opened: ${file}`);
		});
		layout.on('close', ({ file, pane }) => {
			// - a tab has been closed
			// - a pane has been closed
			console.log(`closed: ${file}`);
		});
		layout.on('select', ({ file, pane }) => {
			// - a tab has been selected
			// - a pane has been selected
			// - set activeEditor to pane (if tabbed)
			console.log(`selected: ${file}`);
		});

		const fileSelect = (e) => {
			const pane = activeEditor || document.querySelector('.pane.tabbed').id;
			const file = `/fiugd/beta/dist/editor.html?file=${e.src}`;
			layout.activate({ pane, file });
		};
		const cursorActivity = (e) => {
			const { location } = e.source;
			const pane = location.href.split("paneid=").pop();
			if(location.href.includes("/editor.html") ){
				activeEditor = pane;
			}
			const params = new Proxy(new URLSearchParams(e.source.location.search), {
				get: (searchParams, prop) => searchParams.get(prop),
			});
			const file = params.file && e.source.location.pathname + `?file=${params.file}`;
			layout.activate({ pane, file });
		};

		window.addEventListener("message", (event) => {
			const { triggerEvent, subscribe } = event.data;
			if (triggerEvent?.type === "fileSelect")
				return fileSelect(triggerEvent?.detail);
			if (triggerEvent?.type === "cursorActivity")
				return cursorActivity(event);

			if (triggerEvent) return console.log(`event triggered: `, triggerEvent);
			if (subscribe) return console.log(`request to subscribe: ${subscribe}`);

			console.log(event.data);

			/*
			- document gets message
			- do something with layout

			- paneClose
				- for example, terminal has requested to be closed
			- fileSelect (see above)
			- fileChange
				- if file is open in allPanes, update its status, ie. orange bar at top
			- fileClose
				- if file is open in allPanes, close it
				- if file was active, activate the next tab
			- fileDelete
				- if file is open in allPanes, close it
				- if file was active, activate the next tab
			*/
		});
	</script>
</html>
